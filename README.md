# Отправка псевдофишенгивых писем

Это - учебное приложение для отправки *псевдофишинговых* писем.
Может использоваться для проверки сотрудников/друзей
на внимательность и осторожность при чтении электронных писем.

Владелец приложения должен запустить сервер,
который будет отправлять заранее заготовленные письма
на указанные им адреса электронной почты.
Эти письма будут содержать в себе ссылку на данный сервер,
при переходе по такой ссылке сервер запомнит адрес,
с которого был осуществлен переход.
Далее владелец приложения сможет посмотреть,
с каких электронных адресов был осуществлен переход по ссылке,
и провести этим людям лекцию о том,
что не стоит переходить по подозрительным ссылкам в письмах :)



## На чем это работает?

- Данное приложение написано на `Python3`.
- Для хранения базы данных используется `SQLite3`.
- Для обращения к базе данных используется библиотека `sqlalchemy`.
- Для бэкенда используется библиотека `fastapi`.
- Для отправки сообщений электронной почты используется
библиотека `smtplib`, требуется аккаунт в `Gmail`.
- Для *периодического* начала отправки сообщений используется
библиотека `sched`.


## Объекты базы данных

Можно выделить следующие объекты базы данных:

- `User` - пользователь (администратор) приложения.
Для работы с приложением пользователю необходимо авторизоваться.
- `Subject` - "испытуемый". Характеризуется адресом электронной почты,
на который должна проводиться рассылка писем.
- `LetterToSend` - письмо, которое необходимо отправить
определенному `Subject` (но которое еще не отправлено).
- `LetterWasSent` - отправленное письмо.
Ссылка в тексте письма некоторым образом указывает на данный объект,
переход по ссылке фиксируется (см. ниже).
- `Response` - "отклик" определенного `Subject`
на определенное `LetterWasSent` (результат перехода "испытуемого"
по ссылке).


## Установка и запуск

### Подготовительный этап

#### Скачивание исходного кода

Создайте в любом удобном месте пустую папку,
затем запустите терминал командной строки
(я буду использовать `Microsoft PowerShell`),
перейдите в созданную папку (`cd <путь-до-папки>`)
и склонируйте туда данный репозиторий:
```
git clone "https://github.com/KingAArtur/pseudo_fishing_mails.git"
```
После окончания скачивания перейдите в папку с проектом:
`cd pseudo_fishing_mails`.
Все последующие команды выполняются из корневой папки проекта.

#### Скачивание необходимых библиотек

Желательно предварительно создать виртуальное окружение,
чтобы не засорять свою систему потенциально ненужными библиотеками.
```
python -m venv env
.\env\Scripts\activate
```
Убедитесь в том, что виртуальное окружение подхватилось:
`pip list` должен показывать практически пустой список пакетов.

Опционально обновите pip:
```
python.exe -m pip install --upgrade pip
```

Наконец, установите все необходимые библиотеки:
```
pip install -r .\requirements.txt
```

#### Скачивание SQLite3

Возможно, вам понадобится скачать SQLite3 с официального сайта.

#### Настройка GMail аккаунта для отправки писем

Для отправки писем понадобится Gmail-аккаунт.
В разделе "Безопасность" нужно сгенерировать 16-значный *пароль приложения*
(для этого должна быть включена двухфакторная авторизация),
адрес почты и пароль приложения пригодятся в дальнейшем.

### Запуск сервера

#### Инициализация базы данных

Инициализируйте базу данных:
```
python .\commands.py init-db
```

Создайте пользователя, от лица которого можно будет авторизоваться
в приложении:
```
python .\commands.py create-default-user
```

При необходимости в любой момент можно очистить базу данных:
```
python .\commands.py clear-db
```
После этого потребуется заново ее инициализировать.

#### Запуск приложения

Запустите бэкенд:
```
python .\main.py
```
Приложение будет работать по адресу `http://localhost:8000`,
а по адресу `http://localhost:8000/docs` будет доступна
интерактивная документация, любезно сгенерированная `FastAPI`:

![](/misc/docs_example.png)

Здесь перечислены все запросы, которые умеет обрабатывать приложение,
эти запросы сгруппированы по темам.

Для начала работы необходимо авторизоваться:
нужно нажать на кнопку `Authorize` в правом верхнем углу
и ввести данные пользователя, сгенерированного нами ранее
(логин - `admin`, пароль - `password`):

![](/misc/auth_example.png)

##### Пользователи

- `Read Users` - получение списка всех пользователей или
просмотр конкретного пользователя по его id
- `Create User` - создание нового пользователя
- `Delete User` - удаление пользователя
- `Update User` - смена пароля у пользователя
- `Read Users Me` - просмотр пользователя, под именем которого мы
сейчас авторизованы


##### Испытуемые

- `Read Subjects` - получение списка всех испытуемых или
просмотр конкретного испытуемого по его id или email
- `Create Subject` - создание испытуемого
- `Update Subject` - обновление информации об испытуемом
  (почту поменять нельзя)


##### Будущие письма

- `Read Letters To Send` - получение списка всех писем к отправке,
просмотр одного письма по его id,
просмотр всех писем для конкретного испытуемого.
- `Create Letter` - создание письма.
В тексте можно использовать маски
`{last_name}`, `{first_name}`, `{patronymic}`,
которые при отправке заменятся, соответственно, на
фамилию, имя и отчество (указанные при создании испытуемого).
Также должна присутствовать строчка `{link}`,
вместо которой будет подставлена ссылка.
- `Update Letter` - обновление информации о письме.
- `Delete Letter` - удаление письма.


##### Отправленные письма

- `Read Letters Were Sent` - получение списка всех отправленных писем,
просмотр одного письма по его id,
просмотр всех писем для конкретного испытуемого.


##### Отклики

- `Get All Responses` - получение списка всех откликов,
просмотр всех откликов для конкретного испытуемого.
- `Delete Response` - удаление отклика.

### Запуск отправщика писем

Отправщик писем должен работать одновременно с бэкендом,
поэтому для его запуска удобно будет создать отдельный
экземпляр командной строки.
Не забудьте подхватить в нем виртуальное окружение.

Для отправки писем необходимо в переменных окружения
`GMAIL_LOGIN` и `GMAIL_PASSWORD` указать адрес почты и пароль приложения
от аккаунта `Gmail` (см. выше):
```
$Env:GMAIL_LOGIN='адрес_почты'
$Env:GMAIL_PASSWORD='пароль'
```

Дополнительно в переменной окружения `APP_LINK` необходимо указать
адрес, на котором работает бэкенд
(при локальном тестировании это будет `http://localhost:8000`):
```
$Env:APP_LINK='http://localhost:8000'
```

Далее необходимо запустить сам отправщик писем:
```
python .\src\sender\sender.py
```

Возможно, понадобится указать Python путь к папке проекта:
```
$Env:PYTHONPATH='.'
```

Теперь отправщик писем будет работать, каждые 10 секунд проверяя,
не появились ли новые письма для отправки.
Интервал можно регулировать в константе `SCHEDULE_INTERVAL`
в запускаемом скрипте.

