# Отправка псевдофишенгивых писем

Это - учебное приложение для отправки *псевдофишинговых* писем.
Может использоваться для проверки сотрудников/друзей
на внимательность и осторожность при чтении электронных писем.

Владелец приложения должен запустить сервер,
который будет отправлять заранее заготовленные письма
на указанные им адреса электронной почты.
Эти письма будут содержать в себе ссылку на данный сервер,
при переходе по такой ссылке сервер запомнит адрес,
с которого был осуществлен переход.
Далее владелец приложения сможет посмотреть,
с каких электронных адресов был осуществлен переход по ссылке,
и провести этим людям лекцию о том,
что не стоит переходить по подозрительным ссылкам в письмах :)



## 1. Как это работает?

### Использованные технологии

- **Бэкенд** написан на `Python3` при помощи библиотеки `fastapi`.
- Для хранения базы данных используется `SQLite3`.
- Для обращения к базе данных используется библиотека `sqlalchemy`.


- Для **фронтенда** использован `React` ([Create React App](https://github.com/facebook/create-react-app)).


- **Отправщик** сообщений электронной почты написан на `Python3`,
используется библиотека `smtplib`, требуется аккаунт в `Gmail`.
- Для *периодического* запуска отправки сообщений используется
библиотека `sched`.


### Объекты базы данных

Можно выделить следующие объекты базы данных:

- `User` - пользователь (администратор) приложения.
Для работы с приложением пользователю необходимо авторизоваться.
- `Subject` - "испытуемый". Характеризуется адресом электронной почты,
на который должна проводиться рассылка писем.
- `LetterToSend` - письмо, которое необходимо отправить
определенному `Subject` (но которое еще не отправлено).
- `LetterWasSent` - отправленное письмо.
Ссылка в тексте письма некоторым образом указывает на данный объект,
что позволяет идентифицировать пользователя, который перейдет по этой ссылке.
Переход по ссылке фиксируется (см. ниже).
- `Response` - "отклик" определенного `Subject`
на определенное `LetterWasSent`
(фиксация факта перехода "испытуемого" по ссылке).


## 2. Скачивание и установка

### Скачивание исходного кода

Создайте в любом удобном месте пустую папку,
затем запустите терминал командной строки
(я буду использовать `Microsoft PowerShell`),
перейдите в созданную папку (`cd <путь-до-папки>`)
и склонируйте туда данный репозиторий:
```
git clone "https://github.com/KingAArtur/pseudo_fishing_mails.git"
```
После окончания скачивания перейдите в созданную папку с проектом:
`cd pseudo_fishing_mails`.
Все последующие команды выполняются из данной (корневой) папки проекта.

### Скачивание необходимых библиотек

Желательно предварительно создать виртуальное окружение,
чтобы не засорять свою систему потенциально ненужными библиотеками.
```
python -m venv venv
.\venv\Scripts\activate
```
Убедитесь в том, что виртуальное окружение подхватилось:
`pip list` должен показывать практически пустой список пакетов.

Опционально обновите pip:
```
python.exe -m pip install --upgrade pip
```

Наконец, установите все необходимые библиотеки:
```
pip install -r .\requirements.txt
```

### Скачивание SQLite3

Возможно, вам понадобится установить `SQLite3` с официального сайта.

### Скачивание npm

Убедитесь, что у вас установлен менеджер пакетов JS `npm`:
```
npm
```


## 3. Подготовительная работа

### 3.1. Бэкенд

Инициализируйте базу данных:
```
python .\commands.py init-db
```

Создайте пользователя, от лица которого можно будет авторизоваться
в приложении:
```
python .\commands.py create-default-user
```

При необходимости в любой момент можно очистить базу данных:
```
python .\commands.py clear-db
```
После этого потребуется заново ее инициализировать.

### 3.2. Фронтенд

Перейдите в директорию фронтенда и запустите сборку:
```
cd .\frontend
npm install
```

### 3.3. Отправщик писем

Для отправки писем понадобится Gmail-аккаунт.
В разделе "Безопасность" нужно сгенерировать 16-значный [пароль приложения](https://support.google.com/accounts/answer/185833?hl=ru)
(для этого должна быть включена двухфакторная авторизация),
адрес почты и данный пароль приложения пригодятся в дальнейшем.


## 4. Запуск

Напомню, что все команды (если не указано иное) выполняются из корневой папки проекта.

### 4.1. Запуск бэкенда

Запустите бэкенд:
```
python .\backend\main.py
```
Приложение будет работать по адресу http://localhost:8000,
а по адресу http://localhost:8000/docs будет доступна
интерактивная документация, любезно сгенерированная `FastAPI`:

![](/misc/docs_example.png)

Здесь перечислены все запросы, которые умеет обрабатывать бэкенд,
эти запросы сгруппированы по темам.

### 4.2. Запуск фронтенда

Фронтенд должен работать одновременно с бэкендом,
поэтому для его запуска будет удобно создать отдельный
экземпляр командной строки.

Переходим в директорию фронтенда:
```
cd .\frontend
```

В переменной окружения `REACT_APP_API_BASE_PATH` необходимо указать
адрес, на котором работает бэкенд
(при локальном тестировании это будет `http://localhost:8000`):
```
$Env:REACT_APP_API_BASE_PATH='http://localhost:8000'
```

Теперь запускаем сам фронтенд:
```
npm start
```

Фронтенд (по умолчанию) будет работать по адресу http://localhost:3000.

### 4.3. Запуск отправщика писем

Отправщик писем также должен работать одновременно с бэкендом,
поэтому для его запуска следует создать отдельный
экземпляр командной строки.
Не забудьте подхватить в нем виртуальное окружение:
```
.\venv\Scripts\activate
```

Для отправки писем необходимо в переменных окружения
`GMAIL_LOGIN` и `GMAIL_PASSWORD` указать адрес почты и пароль приложения
от аккаунта `Gmail` (см. выше):
```
$Env:GMAIL_LOGIN='адрес_почты'
$Env:GMAIL_PASSWORD='пароль'
```

Дополнительно в переменной окружения `APP_LINK` необходимо указать
адрес, на котором работает бэкенд
(при локальном тестировании это будет `http://localhost:8000`):
```
$Env:APP_LINK='http://localhost:8000'
```

Далее необходимо запустить сам отправщик писем:
```
python .\sender\sender.py
```

Возможно, для этого понадобится указать Python путь к корневой папке проекта:
```
$Env:PYTHONPATH='.'
```

Теперь отправщик писем будет работать, каждые 10 секунд проверяя,
не появились ли новые письма для отправки.
Интервал можно регулировать в константе `SCHEDULE_INTERVAL`
в запускаемом скрипте.


## 5. Использование

Данная часть предполагает, что все действия будут выполняться на фронтенде,
но при желании это все можно проделать и в интерактивной документации самого бэкенда.

Итак, поле запуска фронтенда на экране должно быть что-то такое:

![](/misc/frontend.png)

### 5.1. Авторизация

Для начала работы необходимо авторизоваться:
нужно нажать на кнопку `Login` в правом верхнем углу
и ввести данные пользователя, сгенерированного нами ранее
(логин - `admin`, пароль - `password`):

![](/misc/frontend_auth.png)

Необходимо будет логиниться заново каждые 30 минут.

### 5.2. Пользователи

Во вкладке `Пользователи` нам доступны действия, касающиеся пользователей (`User`):

![](/misc/frontend_users.png)

Здесь можно создать нового пользователя,
изменить пароль у существующего пользователя
удалить пользователя и посмотреть список всех имеющихся пользователей.

### 5.3. Испытуемые

Во вкладке `Испытуемые` нам доступны действия, касающиеся испытуемых (`Subject`).

Создайте испытуемого с интересующим вас адресом электронной почты.
ФИО указывать необязательно, но эти значения могут автоматически подставляться в текст отправляемых писем:

![](/misc/frontend_subjects_create.png)

Также на этой вкладке можно изменить ФИО у уже существующего испытуемого
и посмотреть список всех имеющихся испытуемых.
При желании можно посмотреть информацию о конкретном испытуемом по его адресу электронной почты:

![](/misc/frontend_subjects_read.png)


### 5.3. Запланированные письма

Во вкладке `Письма к отправке` нам доступны действия, касающиеся еще не отправленных писем (`LetterToSend`).

Создайте новое письмо, перечислив через запятую номера испытуемых:

![](/misc/frontend_letters_create.png)

Время отправки должно быть в формате `YY-MM-DD HH:MM` и указано относительно часового пояса UTC.
В тексте можно использовать маски
`{last_name}`, `{first_name}`, `{patronymic}`,
которые при отправке заменятся, соответственно, на
фамилию, имя и отчество (указанные при создании испытуемого).
Также должна присутствовать подстрока `{link}`,
вместо которой будет подставлена ссылка.

Помимо создания писем, их можно редактировать, удалять и просматривать.

### 5.4. Отправленные письма

Во вкладке `Отправленные письма` нам доступны действия, касающиеся уже отправленных писем (`LetterWasSent`).

Здесь можно только просматривать отправленные письма,
список писем можно фильтровать по номеру испытуемого.
Из-за особенностей реализации подстрока `{link}` в тексте письма здесь останется неизменной
(в самом отправленном письме она заменится на ссылку).

### 5.5. Отклики

Во вкладке `Отклики` нам доступны действия, касающиеся откликов испытуемых на письма (`Response`).

Здесь можно просматривать и удалять отклики, список откликов можно фильтровать по номеру испытуемого.
